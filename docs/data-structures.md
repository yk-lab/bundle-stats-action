# Bundle Stats Action データ構造仕様書

## 1. 入力データ構造

### 1.1 webpack-stats.json

Webpackが生成する統計情報ファイルの構造：

```typescript
interface WebpackStats {
  // バージョン情報
  version?: string
  hash?: string
  time?: number
  builtAt?: number

  // アセット情報（主要な解析対象）
  assets: Asset[]

  // その他の情報（将来の拡張用）
  chunks?: Chunk[]
  modules?: Module[]
  errors?: string[]
  warnings?: string[]
}

interface Asset {
  name: string // ファイル名 (e.g., "main.js", "vendor.bundle.js")
  size: number // ファイルサイズ（バイト単位）
  chunks: (string | number)[] // 関連するチャンクID
  emitted: boolean // ファイルが出力されたか
  isOverSizeLimit?: boolean // Webpackのサイズ制限超過フラグ

  // 追加情報
  info?: {
    immutable?: boolean // 不変アセットか
    minimized?: boolean // 圧縮済みか
    development?: boolean // 開発ビルドか
    hotModuleReplacement?: boolean
  }
}
```

### 1.2 アクション入力パラメータ

```typescript
interface ActionInputs {
  statsPath: string // webpack-stats.jsonのパス
  bundleSizeThreshold: number // 個別ファイルサイズ閾値（バイト）
  totalSizeThreshold: number // 合計サイズ閾値（バイト）
  failOnThresholdExceed: boolean // 閾値超過時の失敗フラグ
}
```

## 2. 内部処理データ構造

### 2.1 解析結果

```typescript
interface AnalysisResult {
  // アセット分析結果
  assets: AnalyzedAsset[]

  // サマリー情報
  summary: {
    totalSize: number
    totalSizeText: string
    fileCount: number
    exceededFileCount: number
  }

  // 閾値判定結果
  threshold: {
    individualExceeded: string[] // 個別閾値超過ファイル名リスト
    totalExceeded: boolean // 合計閾値超過フラグ
    anyExceeded: boolean // いずれかの閾値超過
  }
}

interface AnalyzedAsset {
  name: string // ファイル名
  size: number // サイズ（バイト）
  sizeText: string // 人間可読形式 (e.g., "1.2 MB")
  exceeded: boolean // 個別閾値超過フラグ
  percentage?: number // 全体に対する割合
}
```

### 2.2 フォーマット設定

```typescript
interface FormatOptions {
  maxItems: number // 表示する最大ファイル数（デフォルト: 20）
  sortBy: 'size' | 'name' // ソート基準
  showPercentage: boolean // パーセンテージ表示
  collapsible: boolean // 折りたたみ表示
}
```

## 3. 出力データ構造

### 3.1 PRコメント構造

```markdown
<!-- bundle-stats-action -->

## 📊 Bundle Size Report

**Total Size**: 5.2 MB ⚠️ (threshold: 10 MB)

<details>
<summary>📦 Bundle Details (showing top 10 of 25 files)</summary>

| File       | Size   | Status           |
| ---------- | ------ | ---------------- |
| vendor.js  | 2.3 MB | ❌ Exceeds limit |
| main.js    | 1.5 MB | ✅               |
| styles.css | 800 KB | ✅               |
| ...        | ...    | ...              |

</details>

### ⚠️ Threshold Violations

- **2 files** exceed individual size limit (2 MB)
- Total bundle size is within limit

---

<sub>Generated by Bundle Stats Action</sub>
```

### 3.2 処理中表示

```markdown
<!-- bundle-stats-action -->

## 📊 Bundle Size Report

⏳ **Analyzing bundle stats...**

<details>
<summary>Processing details</summary>

- Reading webpack-stats.json...
- Calculating bundle sizes...
- Checking thresholds...

</details>
```

### 3.3 SVGバッジ構造

```xml
<svg xmlns="http://www.w3.org/2000/svg" width="130" height="20">
  <linearGradient id="b" x2="0" y2="100%">
    <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
    <stop offset="1" stop-opacity=".1"/>
  </linearGradient>
  <clipPath id="a">
    <rect width="130" height="20" rx="3" fill="#fff"/>
  </clipPath>
  <g clip-path="url(#a)">
    <path fill="#555" d="M0 0h75v20H0z"/>
    <path fill="{color}" d="M75 0h55v20H75z"/>
    <path fill="url(#b)" d="M0 0h130v20H0z"/>
  </g>
  <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="110">
    <text x="385" y="150" fill="#010101" fill-opacity=".3" transform="scale(.1)">bundle size</text>
    <text x="385" y="140" transform="scale(.1)">bundle size</text>
    <text x="1015" y="150" fill="#010101" fill-opacity=".3" transform="scale(.1)">{size}</text>
    <text x="1015" y="140" transform="scale(.1)">{size}</text>
  </g>
</svg>
```

色の定義:

- `#4c1`: 正常（緑）
- `#fa0`: 警告（黄）
- `#e05`: エラー（赤）

## 4. エラーレスポンス構造

### 4.1 エラーメッセージフォーマット

```typescript
interface ErrorResponse {
  code: string // エラーコード
  message: string // ユーザー向けメッセージ
  details?: string // 詳細情報（デバッグ用）
  file?: string // 関連ファイル
  line?: number // 行番号（該当する場合）
}
```

### 4.2 エラーコード一覧

| コード               | 説明                             | アクション |
| -------------------- | -------------------------------- | ---------- |
| `FILE_NOT_FOUND`     | webpack-stats.jsonが見つからない | CI失敗     |
| `PARSE_ERROR`        | JSON解析エラー                   | CI失敗     |
| `INVALID_SCHEMA`     | 期待される構造と異なる           | CI失敗     |
| `API_ERROR`          | GitHub API エラー                | 警告&継続  |
| `THRESHOLD_EXCEEDED` | 閾値超過                         | 設定に依存 |

## 5. GitHub API関連

### 5.1 コメント検索クエリ

```typescript
interface CommentSearchParams {
  owner: string
  repo: string
  issue_number: number
  identifier: string // "bundle-stats-action"
}
```

### 5.2 コメント更新ペイロード

```typescript
interface CommentPayload {
  body: string // Markdownコンテンツ
  comment_id?: number // 更新時のみ
}
```

## 6. 設定ファイル構造（将来の拡張）

### 6.1 .bundle-stats.yml（オプション）

```yaml
# 将来的な設定ファイルサポート
version: 1
thresholds:
  individual:
    - pattern: '*.js'
      limit: 2MB
    - pattern: '*.css'
      limit: 500KB
  total: 10MB

display:
  maxFiles: 20
  sortBy: size
  showDiff: true

ignore:
  - '*.map'
  - 'test/**/*'
```

## 7. サイズ計算とフォーマット

### 7.1 サイズ単位変換

```typescript
interface SizeUnit {
  bytes: number
  unit: 'B' | 'KB' | 'MB' | 'GB'
  formatted: string // e.g., "1.23 MB"
}

// 変換ルール
// < 1024 B    -> "xxx B"
// < 1024 KB   -> "x.xx KB"
// < 1024 MB   -> "x.xx MB"
// >= 1024 MB  -> "x.xx GB"
```

### 7.2 初期/最終バンドルの判定

```typescript
interface BundleType {
  isInitial: boolean // エントリーポイントか
  isAsync: boolean // 非同期ロードされるか
  isVendor: boolean // ベンダーバンドルか
}

// 判定ロジック
// - chunks配列が数値を含む -> initial
// - ファイル名に'vendor'を含む -> vendor
// - ファイル名に数値ハッシュのみ -> async
```

## 8. 出力パラメータ

```typescript
interface ActionOutputs {
  commentBody: string // 投稿されたコメントの内容
  exceeded: string // "true" | "false" (文字列)
  badgeSvg: string // SVGバッジのコンテンツ
  totalSize: string // 合計サイズ（バイト）
  fileCount: string // ファイル数
}
```

これらのデータ構造は、アクションの入力から出力まで一貫性を保ち、型安全性を確保するための基盤となります。
